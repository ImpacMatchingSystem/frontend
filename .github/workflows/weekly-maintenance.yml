name: ğŸ”§ Weekly Maintenance

on:
  schedule:
    - cron: '0 9 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  maintenance:
    name: ğŸ”§ Weekly Maintenance Tasks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Check for security vulnerabilities
        run: |
          echo "## ğŸ”’ Security Audit Report" >> maintenance-report.md
          npm audit --json > audit.json || true

          if [ -s audit.json ]; then
            vulnerabilities=$(cat audit.json | jq '.metadata.vulnerabilities | to_entries[] | select(.value > 0)')
            if [ ! -z "$vulnerabilities" ]; then
              echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:" >> maintenance-report.md
              echo "\`\`\`" >> maintenance-report.md
              npm audit >> maintenance-report.md
              echo "\`\`\`" >> maintenance-report.md
            else
              echo "âœ… ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> maintenance-report.md
            fi
          fi

      - name: ğŸ“‹ Check outdated packages
        run: |
          echo "" >> maintenance-report.md
          echo "## ğŸ“¦ Outdated Packages" >> maintenance-report.md
          outdated=$(npm outdated --json || echo '{}')

          if [ "$outdated" != "{}" ]; then
            echo "âš ï¸ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€:" >> maintenance-report.md
            echo "\`\`\`" >> maintenance-report.md
            npm outdated >> maintenance-report.md || true
            echo "\`\`\`" >> maintenance-report.md
          else
            echo "âœ… ëª¨ë“  íŒ¨í‚¤ì§€ê°€ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤." >> maintenance-report.md
          fi

      - name: ğŸ“Š Generate project stats
        run: |
          echo "" >> maintenance-report.md
          echo "## ğŸ“Š Project Statistics" >> maintenance-report.md
          echo "- ì´ íŒŒì¼ ìˆ˜: $(find src -name '*.ts' -o -name '*.tsx' | wc -l)" >> maintenance-report.md
          echo "- ì»´í¬ë„ŒíŠ¸ ìˆ˜: $(find src/components -name '*.tsx' | wc -l)" >> maintenance-report.md
          echo "- API ë¼ìš°íŠ¸ ìˆ˜: $(find src/api -name 'route.ts' | wc -l)" >> maintenance-report.md
          echo "- ì»¤ìŠ¤í…€ í›… ìˆ˜: $(find src/hooks -name '*.ts' | wc -l)" >> maintenance-report.md

      - name: ğŸ’¬ Comment maintenance report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');

            if (fs.existsSync('maintenance-report.md')) {
              const report = fs.readFileSync('maintenance-report.md', 'utf8');
              
              // ê¸°ì¡´ maintenance ì´ìŠˆ ì°¾ê¸°
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'ğŸ”§ maintenance',
                state: 'open'
              });
              
              const title = `ğŸ”§ Weekly Maintenance Report - ${new Date().toISOString().split('T')[0]}`;
              
              if (issues.length > 0) {
                // ê¸°ì¡´ ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues[0].number,
                  body: report
                });
              } else {
                // ìƒˆ ì´ìŠˆ ìƒì„±
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: report,
                  labels: ['ğŸ”§ maintenance']
                });
              }
            }
