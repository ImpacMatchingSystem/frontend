name: ğŸ” Code Quality Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lint-and-format:
    name: ğŸ§¹ ESLint & Prettier Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ¨ Check Prettier formatting
        run: npm run format:check

      - name: ğŸ“ TypeScript type check
        run: npm run type-check

  commit-message-check:
    name: ğŸ“ Commit Message Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check commit messages
        run: |
          # PRì˜ ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ í™•ì¸
          commits=$(git log --format="%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})

          echo "ğŸ” ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì‚¬ ì¤‘..."
          echo "$commits"

          # ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ ê²€ì‚¬
          valid_pattern="^(ğŸìƒˆê¸°ëŠ¥|ğŸ› ê°œì„ |ğŸ›ì˜¤ë¥˜|ğŸ¨ë¦¬íŒ©í† ë§|ğŸ“ë¬¸ì„œ|ğŸš€ë°°í¬):"

          while IFS= read -r commit; do
            if [[ ! $commit =~ $valid_pattern ]]; then
              echo "âŒ ì˜ëª»ëœ ì»¤ë°‹ ë©”ì‹œì§€ í˜•ì‹: $commit"
              echo ""
              echo "ì˜¬ë°”ë¥¸ í˜•ì‹:"
              echo "ğŸìƒˆê¸°ëŠ¥: ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€"
              echo "ğŸ› ê°œì„ : ê¸°ì¡´ ê¸°ëŠ¥ ê°œì„ " 
              echo "ğŸ›ì˜¤ë¥˜: ë²„ê·¸ ìˆ˜ì •"
              echo "ğŸ¨ë¦¬íŒ©í† ë§: ì½”ë“œ ë¦¬íŒ©í† ë§"
              echo "ğŸ“ë¬¸ì„œ: ë¬¸ì„œ ì‘ì—…"
              echo "ğŸš€ë°°í¬: ë°°í¬ ê´€ë ¨"
              exit 1
            fi
          done <<< "$commits"

          echo "âœ… ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì˜¬ë°”ë¥¸ í˜•ì‹ì…ë‹ˆë‹¤!"

  dependency-check:
    name: ğŸ”’ Security & Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”’ Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ğŸ“‹ Check for outdated packages
        run: npm outdated || true
